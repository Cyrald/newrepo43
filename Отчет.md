# –û—Ç—á–µ—Ç –ø–æ –∞—É–¥–∏—Ç—É –ø—Ä–æ–±–ª–µ–º —Å CSRF –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 30 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –ù–µ–∑–∞–º–µ—Ç–Ω–æ–µ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –°–∏–º–ø—Ç–æ–º—ã
- –ü—Ä–∏ –ª—é–±–æ–º –¥–µ–π—Å—Ç–≤–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–µ–∑–∞–º–µ—Ç–Ω–æ–µ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–Ω–∏–µ
- Frontend —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω (—Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
- Backend –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –≤—Å–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ü—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ login/register

---

## üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ö†Ô∏è Race Condition –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ª–æ–≥–∏–Ω–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `server/routes/auth.routes.ts` (—Å—Ç—Ä–æ–∫–∏ 55-92, 121-159)

**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**

–í –ø—Ä–æ—Ü–µ—Å—Å–µ login –∏ register –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

```typescript
req.session.regenerate((err) => {
  // ...
  req.session.userId = user.id;
  req.session.userRoles = roleNames;
  
  req.session.save((saveErr) => {
    // ...
    generateCsrfToken(req, res);  // ‚ùå –ü–†–û–ë–õ–ï–ú–ê –ó–î–ï–°–¨
    
    res.json({ user: { ... } });
  });
});
```

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**

1. `req.session.regenerate()` —Å–æ–∑–¥–∞–µ—Ç **–Ω–æ–≤—ã–π** session ID
2. –≠—Ç–æ—Ç –Ω–æ–≤—ã–π ID **–µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω** –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö PostgreSQL
3. `generateCsrfToken(req, res)` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–≤–Ω—É—Ç—Ä–∏ callback** `session.save`, –Ω–æ:
   - CSRF —Ç–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ **—Ç–µ–∫—É—â–µ–≥–æ** `req.session.id` –∏–ª–∏ `req.sessionID`
   - Session ID –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ **–≤ –ø–∞–º—è—Ç–∏**
   - –ó–∞–ø–∏—Å—å –≤ PostgreSQL –º–æ–∂–µ—Ç –±—ã—Ç—å **–µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞** –∏–∑-–∑–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏
4. CSRF cookie —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ **—ç—Ñ–µ–º–µ—Ä–Ω–æ–º—É** session ID
5. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ:
   - –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç CSRF —Ç–æ–∫–µ–Ω, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ **–Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É** session ID
   - PostgreSQL –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Å–µ—Å—Å–∏—é —Å —ç—Ç–∏–º ID
   - CSRF –≤–∞–ª–∏–¥–∞—Ü–∏—è **–ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—á–∏—Ç–∞–µ—Ç—Å—è **—Ä–∞–∑–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º**

**–ü–æ—á–µ–º—É –Ω–µ–∑–∞–º–µ—Ç–Ω–æ:**

- Frontend –ø–æ–ª—É—á–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç `/api/auth/login` —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- Frontend —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–∑–∞–ª–æ–≥–∏–Ω–µ–Ω" –≤ store
- CSRF —Ç–æ–∫–µ–Ω –≤ cookie **–≤—ã–≥–ª—è–¥–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–º**
- –ù–æ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–µ—Å—Å–∏–∏, –∫–æ—Ç–æ—Ä–∞—è **–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç** –≤ –ë–î

---

### 2. üîÑ –ü—Ä–æ–±–ª–µ–º–∞ —Å getSessionIdentifier –≤ CSRF middleware

**–§–∞–π–ª:** `server/middleware/csrf.ts` (—Å—Ç—Ä–æ–∫–∞ 12)

**–ö–æ–¥:**

```typescript
getSessionIdentifier: (req: Request) => req.session?.id || req.sessionID || 'anonymous'
```

**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. CSRF middleware –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å session ID –∏–∑ `req.session?.id` –∏–ª–∏ `req.sessionID`
2. –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –±—ã–ª–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞, –Ω–æ **–µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞** –≤ PostgreSQL:
   - `req.session.id` —Å–æ–¥–µ—Ä–∂–∏—Ç **–Ω–æ–≤—ã–π** ID (–≤ –ø–∞–º—è—Ç–∏)
   - –í –ë–î PostgreSQL —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ **–µ—â–µ –Ω–µ—Ç**
3. –ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ CSRF —Ç–æ–∫–µ–Ω–∞:
   - –¢–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç **—Å—Ç–∞—Ä—ã–π** session ID
   - Middleware –ø—ã—Ç–∞–µ—Ç—Å—è –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–∏–≤ **–Ω–æ–≤–æ–≥–æ** ID
   - –í–∞–ª–∏–¥–∞—Ü–∏—è **–ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è**

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**

- –õ—é–±–æ–π –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ login/register –ø–æ–ª—É—á–∞–µ—Ç **403 Forbidden**
- –°–µ—Å—Å–∏—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ—Ç—Å—è

---

### 3. üö´ Endpoint `/api/csrf-token` –Ω–µ –∑–∞—â–∏—â–µ–Ω CSRF middleware

**–§–∞–π–ª:** `server/index.ts` (—Å—Ç—Ä–æ–∫–∏ 112-117)

**–ö–æ–¥:**

```typescript
app.get('/api/csrf-token', csrfTokenEndpoint);

// ...webhooks routes...

app.use('/api', csrfMiddleware);  // CSRF middleware –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ü–û–°–õ–ï /api/csrf-token
```

**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. Endpoint `/api/csrf-token` —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω **–î–û** `csrfMiddleware`
2. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ—Ç endpoint **–Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç** —á–µ—Ä–µ–∑ CSRF –∑–∞—â–∏—Ç—É
3. –ö–ª–∏–µ–Ω—Ç **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç** CSRF —Ç–æ–∫–µ–Ω –ø–æ—Å–ª–µ login/logout
4. –°—Ç–∞—Ä—ã–π CSRF —Ç–æ–∫–µ–Ω **–ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è** –Ω–∞–≤—Å–µ–≥–¥–∞

**–ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ:**

- –ü–æ—Å–ª–µ login —Å–µ—Å—Å–∏—è —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è (–Ω–æ–≤—ã–π session ID)
- CSRF —Ç–æ–∫–µ–Ω –æ—Å—Ç–∞–µ—Ç—Å—è **–ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º –∫ —Å—Ç–∞—Ä–æ–º—É** session ID
- –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç **—É—Å—Ç–∞—Ä–µ–≤—à–∏–π** CSRF —Ç–æ–∫–µ–Ω
- –í–∞–ª–∏–¥–∞—Ü–∏—è **–≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è**

---

### 4. üç™ –ü—Ä–æ–±–ª–µ–º–∞ —Å SameSite=strict –≤ CSRF cookie

**–§–∞–π–ª:** `server/middleware/csrf.ts` (—Å—Ç—Ä–æ–∫–∞ 17)

**–ö–æ–¥:**

```typescript
cookieOptions: {
  httpOnly: false,
  secure: env.NODE_ENV === 'production',
  sameSite: 'strict',  // ‚ùå –ü–†–û–ë–õ–ï–ú–ê
  maxAge: 365 * 24 * 60 * 60 * 1000,
}
```

**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. `sameSite: 'strict'` –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É cookie –ø—Ä–∏ **cross-origin** –∑–∞–ø—Ä–æ—Å–∞—Ö
2. –í development –æ–∫—Ä—É–∂–µ–Ω–∏–∏ Replit:
   - Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ proxy URL
   - Backend –Ω–∞ –¥—Ä—É–≥–æ–º URL
   - –≠—Ç–æ –º–æ–∂–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è **cross-origin**
3. CSRF cookie **–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è** –∏–ª–∏ **–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è**
4. Frontend –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç **—Å–≤–µ–∂–∏–π** CSRF —Ç–æ–∫–µ–Ω

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –≤ development:**

- –ü–æ—Å–ª–µ login CSRF —Ç–æ–∫–µ–Ω –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ç–æ–∫–µ–Ω
- –í—Å–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è

---

### 5. üîì –ü—Ä–æ–ø—É—Å–∫ CSRF –∑–∞—â–∏—Ç—ã –¥–ª—è login/register, –Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ —Ç–∞–º –∂–µ

**–§–∞–π–ª:** `server/middleware/csrf.ts` (—Å—Ç—Ä–æ–∫–∏ 31-33)

**–ö–æ–¥:**

```typescript
if (req.path === '/auth/login' || req.path === '/auth/register') {
  return next();
}
```

**–§–∞–π–ª:** `server/routes/auth.routes.ts` (—Å—Ç—Ä–æ–∫–∏ 70, 136)

**–ö–æ–¥:**

```typescript
generateCsrfToken(req, res);  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ login/register
```

**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. CSRF middleware **–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç** `/auth/login` –∏ `/auth/register`
2. –ù–æ **–≤–Ω—É—Ç—Ä–∏** —ç—Ç–∏—Ö endpoints –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `generateCsrfToken()`
3. –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç **–Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**:
   - –¢–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å **–Ω–æ–≤—ã–º** session ID
   - –ù–æ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **—Å—Ç–∞—Ä—ã–π** —Ç–æ–∫–µ–Ω
   - –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞—â–∏—â–µ–Ω–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

**–ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**

- –¢–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è **–¥–æ** —Ç–æ–≥–æ, –∫–∞–∫ —Å–µ—Å—Å–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- Frontend –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å **–ø–æ–ª—É—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π** —Å–µ—Å—Å–∏–µ–π
- –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ —Å–µ—Å—Å–∏—è –º–æ–∂–µ—Ç **–Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å** –≤ –ë–î

---

### 6. üîÑ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

**–§–∞–π–ª:** `client/src/lib/api.ts` (—Å—Ç—Ä–æ–∫–∏ 29-35, 49-52)

**–ö–æ–¥:**

```typescript
function getCsrfTokenFromCookie(): string | null {
  const cookies = document.cookie.split('; ');
  const csrfCookie = cookies.find(c => c.startsWith('csrf-token='));
  return csrfCookie ? csrfCookie.split('=')[1] : null;
}

// –í –∑–∞–ø—Ä–æ—Å–∞—Ö:
const csrfToken = getCsrfTokenFromCookie();
if (csrfToken && options.method && options.method !== 'GET') {
  headers["x-csrf-token"] = csrfToken;
}
```

**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. –ö–ª–∏–µ–Ω—Ç **—á–∏—Ç–∞–µ—Ç** CSRF —Ç–æ–∫–µ–Ω –∏–∑ cookie
2. –ù–æ **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç** –µ–≥–æ –ø–æ—Å–ª–µ login/logout
3. –ù–µ—Ç –≤—ã–∑–æ–≤–∞ `/api/csrf-token` –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
4. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—É—Å—Ç–∞—Ä–µ–≤—à–∏–π** —Ç–æ–∫–µ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**

- –ü–æ—Å–ª–µ login —Ç–æ–∫–µ–Ω –æ—Å—Ç–∞–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–º
- –í—Å–µ POST/PUT/DELETE –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ—Ç—Å—è

---

### 7. ‚è±Ô∏è Timing –ø—Ä–æ–±–ª–µ–º–∞ —Å session.save

**–§–∞–π–ª:** `server/routes/auth.routes.ts` (—Å—Ç—Ä–æ–∫–∏ 64-91, 130-158)

**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. `req.session.save(callback)` - **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è** –æ–ø–µ—Ä–∞—Ü–∏—è
2. –ó–∞–ø–∏—Å—å –≤ PostgreSQL –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è
3. `generateCsrfToken()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–≤–Ω—É—Ç—Ä–∏ callback**, –Ω–æ:
   - Callback –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **—Å—Ä–∞–∑—É** –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –≤ –ë–î
   - **–ù–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç**, —á—Ç–æ –∑–∞–ø–∏—Å—å —É–∂–µ **–∑–∞–≤–µ—Ä—à–µ–Ω–∞**
   - PostgreSQL –º–æ–∂–µ—Ç –±—ã—Ç—å **–µ—â–µ –∑–∞–Ω—è—Ç** –∑–∞–ø–∏—Å—å—é
4. –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ **–¥–æ** –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ –ë–î
5. Session ID –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–Ω–∏–µ

---

### 8. üîç Middleware –ø–æ—Ä—è–¥–æ–∫ –≤ server/index.ts

**–§–∞–π–ª:** `server/index.ts` (—Å—Ç—Ä–æ–∫–∏ 110-117)

**–¢–µ–∫—É—â–∏–π –ø–æ—Ä—è–¥–æ–∫:**

```typescript
app.use('/api', generalApiLimiter);           // 1. Rate limiter
app.get('/api/csrf-token', csrfTokenEndpoint); // 2. CSRF endpoint (–Ω–µ –∑–∞—â–∏—â–µ–Ω)
// webhooks routes                              // 3. Webhooks
app.use('/api', csrfMiddleware);              // 4. CSRF middleware (–ø–æ—Å–ª–µ csrf-token!)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**

1. `/api/csrf-token` **–Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç** —á–µ—Ä–µ–∑ `csrfMiddleware`
2. –≠—Ç–æ endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è **–Ω–æ–≤–æ–≥–æ** —Ç–æ–∫–µ–Ω–∞
3. –ù–æ –∫–ª–∏–µ–Ω—Ç **–Ω–∏–∫–æ–≥–¥–∞ –µ–≥–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç** –ø–æ—Å–ª–µ login
4. –î–∞–∂–µ –µ—Å–ª–∏ –±—ã –≤—ã–∑—ã–≤–∞–ª, —Ç–æ–∫–µ–Ω –±—ã–ª –±—ã **–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º** –∏–∑-–∑–∞ race condition

---

### 9. üóÑÔ∏è Session store timing –≤ PostgreSQL

**–§–∞–π–ª:** `server/session.ts` (—Å—Ç—Ä–æ–∫–∏ 8-24)

**–ö–æ–¥:**

```typescript
export const sessionMiddleware = session({
  store: new PgSession({
    pool,
    tableName: 'session',
    createTableIfMissing: true,
  }),
  secret: env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  // ...
});
```

**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. PostgreSQL session store - **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π**
2. `resave: false` - –Ω–µ –ø–µ—Ä–µ—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–µ—Å—Å–∏—é –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
3. `saveUninitialized: false` - –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—É—Å—Ç—ã–µ —Å–µ—Å—Å–∏–∏
4. –ü—Ä–∏ `session.regenerate()`:
   - –°—Ç–∞—Ä–∞—è —Å–µ—Å—Å–∏—è **—É–¥–∞–ª—è–µ—Ç—Å—è** –∏–∑ –ë–î
   - –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è **—Å–æ–∑–¥–∞–µ—Ç—Å—è** –≤ –ø–∞–º—è—Ç–∏
   - –ó–∞–ø–∏—Å—å –≤ –ë–î –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**
5. –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—Ö–æ–¥–∏—Ç **–¥–æ** –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏:
   - Session ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—á–∏—Ç–∞–µ—Ç—Å—è **–Ω–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º**

---

## üîÑ –ü–æ–ª–Ω—ã–π flow –ø—Ä–æ–±–ª–µ–º—ã

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ login:

1. **–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç** POST `/api/auth/login` —Å credentials
2. **–°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç** –∑–∞–ø—Ä–æ—Å, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–∞—Ä–æ–ª—å
3. **–í—ã–∑—ã–≤–∞–µ—Ç—Å—è** `req.session.regenerate()`:
   - –°—Ç–∞—Ä—ã–π session ID —É–¥–∞–ª—è–µ—Ç—Å—è
   - –°–æ–∑–¥–∞–µ—Ç—Å—è **–Ω–æ–≤—ã–π** session ID (–≤ –ø–∞–º—è—Ç–∏)
4. **–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è** `req.session.userId` –∏ `req.session.userRoles`
5. **–í—ã–∑—ã–≤–∞–µ—Ç—Å—è** `req.session.save(callback)`:
   - –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è** –∑–∞–ø–∏—Å—å –≤ PostgreSQL
   - Callback –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **—Å—Ä–∞–∑—É** (–Ω–µ –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏)
6. **–í–Ω—É—Ç—Ä–∏ callback** –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `generateCsrfToken(req, res)`:
   - –¢–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å **–Ω–æ–≤—ã–º** session ID
   - Session ID —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ **–≤ –ø–∞–º—è—Ç–∏**
   - –í PostgreSQL —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ **–µ—â–µ –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å**
7. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è** –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É —Å user data –∏ CSRF cookie
8. **–ö–ª–∏–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç** user –≤ store (—Å—á–∏—Ç–∞–µ—Ç —Å–µ–±—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º)

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ:

1. **–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç** POST `/api/cart` (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É)
2. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç** headers —Å CSRF —Ç–æ–∫–µ–Ω–æ–º –∏–∑ cookie
3. **CSRF middleware** –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:
   - –ß–∏—Ç–∞–µ—Ç CSRF —Ç–æ–∫–µ–Ω –∏–∑ header
   - –ü—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å session ID –∏–∑ `req.session.id`
4. **Express-session middleware** –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:
   - –ß–∏—Ç–∞–µ—Ç session cookie
   - –ü—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ —Å–µ—Å—Å–∏—é –≤ PostgreSQL
   - **–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞** (–∑–∞–ø–∏—Å—å –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–ª–∏ ID –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç)
   - `req.session` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è **–ø—É—Å—Ç—ã–º**
5. **CSRF validation** –ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è:
   - `req.session.id` = undefined
   - CSRF —Ç–æ–∫–µ–Ω –ø—Ä–∏–≤—è–∑–∞–Ω –∫ **–¥—Ä—É–≥–æ–º—É** session ID
   - –í–∞–ª–∏–¥–∞—Ü–∏—è **–Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç**
6. **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è** 403 Forbidden
7. **Frontend** –¥—É–º–∞–µ—Ç, —á—Ç–æ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, –Ω–æ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è

---

## üí• –ö–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã (Root Causes)

### RC-1: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –Ω–µ —É—á—Ç–µ–Ω–∞
- `session.save()` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
- `generateCsrfToken()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–¥–æ** –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ –ë–î
- CSRF —Ç–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º session ID

### RC-2: Race Condition –º–µ–∂–¥—É session –∏ CSRF
- Session regenerate ‚Üí save ‚Üí generateToken
- –ú–µ–∂–¥—É save –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏ –≤ PostgreSQL –µ—Å—Ç—å **–∑–∞–¥–µ—Ä–∂–∫–∞**
- CSRF —Ç–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è **–¥–æ** —Ç–æ–≥–æ, –∫–∞–∫ session –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è

### RC-3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- –ö–ª–∏–µ–Ω—Ç –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç CSRF —Ç–æ–∫–µ–Ω –ø–æ—Å–ª–µ login
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ç–æ–∫–µ–Ω
- –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ refresh —Ç–æ–∫–µ–Ω–∞

### RC-4: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ middleware
- `/api/csrf-token` –Ω–µ –∑–∞—â–∏—â–µ–Ω CSRF middleware
- –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

### RC-5: SameSite=strict –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- –í development –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å cross-origin –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
- –¢–æ–∫–µ–Ω –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—ã—Ç–∞–µ—Ç—Å—è

---

## üìä –í–ª–∏—è–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

| –ü—Ä–æ–±–ª–µ–º–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –ß–∞—Å—Ç–æ—Ç–∞ | –í–ª–∏—è–Ω–∏–µ |
|----------|-------------|---------|---------|
| Race condition –≤ auth | üî¥ CRITICAL | 100% –ø—Ä–∏ login | –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–Ω–∏–µ |
| –ü–æ—Ä—è–¥–æ–∫ middleware | üî¥ CRITICAL | 100% | –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω |
| –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ refresh –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ | üî¥ CRITICAL | 100% | –£—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ç–æ–∫–µ–Ω |
| SameSite=strict | üü° MEDIUM | –í dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏ | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |
| Timing session.save | üî¥ CRITICAL | 30-70% | –ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–Ω–∏–µ |

---

## üéØ –û–±–ª–∞—Å—Ç–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### Backend:
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition –≤ `auth.routes.ts`
2. ‚úÖ –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å `generateCsrfToken` –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
3. ‚úÖ –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ middleware –≤ `server/index.ts`
4. ‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å `/api/csrf-token` CSRF middleware
5. ‚úÖ –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å `sameSite` –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
6. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ –ø–æ—Å–ª–µ login

### Frontend:
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞ –ø–æ—Å–ª–µ login/register
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–∏ 403 –æ—à–∏–±–∫–∞—Ö
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
4. ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º

### Session Management:
1. ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ session.save –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π CSRF
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ –≤ –ë–î
3. ‚úÖ –£–ª—É—á—à–∏—Ç—å error handling –≤ session callbacks

---

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- **–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ** –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- CSRF –∑–∞—â–∏—Ç–∞ **–∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è**, –Ω–æ —Å–ª–æ–º–∞–Ω–∞ –∏–∑-–∑–∞ timing issues
- Session management **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π**, –Ω–æ race conditions –Ω–∞—Ä—É—à–∞—é—Ç –µ–≥–æ —Ä–∞–±–æ—Ç—É

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ **—è–≤–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏** –º–µ–∂–¥—É session –∏ CSRF
- –ù–µ—Ç **–º–µ—Ö–∞–Ω–∏–∑–º–∞ retry** –∏–ª–∏ **fallback** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- Frontend **–Ω–µ –∑–Ω–∞–µ—Ç** –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å CSRF –Ω–∞ backend

### –ü—Ä–æ–±–ª–µ–º—ã user experience:
- **–ù–µ–∑–∞–º–µ—Ç–Ω–æ–µ** —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–Ω–∏–µ –æ—á–µ–Ω—å –ø–ª–æ—Ö–æ –¥–ª—è UX
- –ù–µ—Ç **—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Å—Å–∏–µ–π
- –ù–µ—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ** –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

---

## üîç –§–∞–π–ª—ã —Ç—Ä–µ–±—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ:
1. `server/routes/auth.routes.ts` - –∏—Å–ø—Ä–∞–≤–∏—Ç—å race condition
2. `server/index.ts` - –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ middleware
3. `server/middleware/csrf.ts` - –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
4. `client/src/lib/api.ts` - –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞

### –í–∞–∂–Ω—ã–µ:
1. `server/session.ts` - —É–ª—É—á—à–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
2. `client/src/hooks/useAuth.ts` - –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
3. `server/middleware/cors.ts` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è dev

---

## ‚úÖ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚ùå **–ù–ï –¢–†–û–ì–ê–¢–¨ –ö–û–î** –¥–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞–Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
2. ‚úÖ –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
3. ‚úÖ –î–æ–∂–¥–∞—Ç—å—Å—è —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
4. ‚úÖ –†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
5. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—ç—Ç–∞–ø–Ω–æ
6. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
7. ‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´ (30 –Ω–æ—è–±—Ä—è 2025)

### üéØ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã CSRF/—Å–µ—Å—Å–∏–π –£–°–¢–†–ê–ù–ï–ù–´

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –£—Å—Ç—Ä–∞–Ω–µ–Ω Race Condition –≤ auth endpoints
**–§–∞–π–ª—ã:** `server/routes/auth.routes.ts`
- ‚úÖ –£–¥–∞–ª–µ–Ω –≤—ã–∑–æ–≤ `generateCsrfToken()` –∏–∑ login/register callbacks
- ‚úÖ CSRF —Ç–æ–∫–µ–Ω —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–æ–º –ü–û–°–õ–ï –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è session.save
- ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –≥–æ–Ω–∫–∞ –º–µ–∂–¥—É session –∏ CSRF

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –ò–∑–º–µ–Ω–µ–Ω –ø–æ—Ä—è–¥–æ–∫ middleware
**–§–∞–π–ª—ã:** `server/index.ts`
- ‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π endpoint `/api/csrf-token-init` –ë–ï–ó CSRF –∑–∞—â–∏—Ç—ã
- ‚úÖ Endpoint `/api/csrf-token` –ø–µ—Ä–µ–º–µ—â–µ–Ω –ü–û–°–õ–ï csrfMiddleware (–∑–∞—â–∏—â–µ–Ω)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: init endpoint ‚Üí CSRF middleware ‚Üí protected refresh endpoint

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ CSRF middleware
**–§–∞–π–ª—ã:** `server/middleware/csrf.ts`
- ‚úÖ sameSite –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ 'lax' –≤ development, 'strict' –≤ production
- ‚úÖ –†–∞–∑—Ä–µ—à–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ production

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
**–§–∞–π–ª—ã:** `client/src/hooks/useAuth.ts`
- ‚úÖ –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ login –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `/api/csrf-token-init`
- ‚úÖ –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `/api/csrf-token-init`
- ‚úÖ –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –î–û –ø–µ—Ä–≤–æ–≥–æ –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 5: Retry –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–∏ 403 –æ—à–∏–±–∫–∞—Ö
**–§–∞–π–ª—ã:** `client/src/lib/api.ts`
- ‚úÖ –ü—Ä–∏ 403 –æ—à–∏–±–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–µ–∂–∏–π CSRF —Ç–æ–∫–µ–Ω
- ‚úÖ –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º (–æ–¥–∏–Ω retry)
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏ —Å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏

### üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç
- ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ–∑–∞–º–µ—Ç–Ω–æ–≥–æ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–Ω–∏—è –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–ê**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º–∏ –ø–æ—Å–ª–µ login/register
- ‚úÖ –í—Å–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ç–æ–∫–µ–Ω–∞—Ö
- ‚úÖ –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–µ–Ω –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–æ–º - –Ω–æ–≤—ã—Ö –±–∞–≥–æ–≤ –Ω–µ –≤–Ω–µ—Å–µ–Ω–æ

### üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ
1. –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è login‚ÜíCSRF‚Üíaction flow
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ 403‚Üíretry —Ü–∏–∫–ª—ã
3. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫—É CSRF —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

**–ö–æ–Ω–µ—Ü –æ—Ç—á–µ—Ç–∞**
