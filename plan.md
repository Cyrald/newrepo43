# План реализации трехуровневой системы управления чатом поддержки

## Общее описание

Реализована полнофункциональная трехуровневая система управления чатом поддержки с соответствием законодательству РФ (152-ФЗ о защите персональных данных). Система поддерживает три статуса диалога: **Открыт** (активный), **Архивирован** (разрешено), **Закрыт** (постоянный).

---

## 1. Обновления схемы базы данных

### Таблица `supportConversations`

#### Изменения статуса:
- ✅ Изменен тип `status` с boolean на enum: `'open' | 'archived' | 'closed'`
- ✅ Удалено ограничение UNIQUE на `userId` (теперь возможны несколько диалогов пользователя с разными статусами)

#### Добавленные поля:
- ✅ `closedAt: timestamp | null` - время постоянного закрытия диалога (сохраняется в БД на 3 года по 152-ФЗ)
- ✅ `lastMessageAt: timestamp | null` - время последнего сообщения (используется для сортировки по свежести)
- ✅ `archivedAt: timestamp | null` - время архивирования диалога

---

## 2. Функции хранилища (server/storage.ts)

### Основные функции управления статусом

#### `getOrCreateConversation(userId: string): Promise<SupportConversation>`
**Поведение:**
- Если есть открытый диалог → возвращает его
- Если есть архивированный диалог → перевод в статус 'open' и возврат
- Если только закрытый диалог → создание нового диалога со статусом 'open'
**Назначение:** Автоматическое переоткрытие архивных диалогов при отправке нового сообщения

#### `getActiveConversation(userId: string): Promise<SupportConversation | undefined>`
**Назначение:** Получить активный (открыт или архивирован) диалог пользователя
**Сортировка:** По `lastMessageAt` (DESC)

#### `getConversationStatus(userId: string): Promise<{ status: string } | undefined>`
**Назначение:** Получить текущий статус диалога пользователя (для фронтенда)
**Использование:** Быстрая проверка статуса без получения всех данных

#### `archiveConversation(userId: string): Promise<void>`
**Действия:**
- Переход: 'open' → 'archived'
- Установка `archivedAt = now()`
- Обновление `updatedAt`

#### `closeConversation(userId: string): Promise<void>`
**Действия:**
- Переход: 'open' или 'archived' → 'closed'
- Установка `closedAt = now()`
- Обновление `updatedAt`
**Важно:** Постоянный статус, диалог не может быть переоткрыт из закрытого состояния

#### `reopenConversation(userId: string): Promise<void>`
**Действия:**
- Переход: 'archived' → 'open'
- Установка `archivedAt = null`
- Обновление `lastMessageAt` и `updatedAt`
**Ограничение:** Работает только для архивных диалогов, не для закрытых

#### `updateLastMessageTime(userId: string): Promise<void>`
**Назначение:** Обновить время последнего сообщения при отправке
**Действия:** Установить `lastMessageAt = now()` и обновить `updatedAt`

#### `searchClosedConversations(filters: { email?, dateFrom?, dateTo? }): Promise<Conversation[]>`
**Фильтры:**
- `email` - поиск по email пользователя (LIKE)
- `dateFrom` - закрытые после этой даты (GTE)
- `dateTo` - закрытые до этой даты (LTE)
**Сортировка:** По `closedAt` (DESC)
**Назначение:** Поиск закрытых диалогов в админ-панели

#### `getAllSupportConversations(status?: 'open' | 'archived' | 'closed'): Promise<Conversation[]>`
**Параметры:**
- Если `status` не указан → возвращает все диалоги
- Если `status` указан → фильтрует по статусу
**Сортировка:** По `lastMessageAt` (DESC) - самые свежие сверху
**Возвращаемые данные:** `userId`, `lastMessage`, `status`, `archivedAt`, `closedAt`

---

## 3. API Endpoints (server/routes.ts)

### GET `/api/support/conversations?status=open|archived|closed`
**Назначение:** Получить список диалогов с фильтром по статусу (админ и консультант)
**Параметры:** `status` - необязательный query параметр
**Возвращает:** Массив диалогов, отсортированных по `lastMessageAt` (DESC)

### PUT `/api/support/conversations/:userId/archive`
**Назначение:** Архивировать диалог (админ и консультант)
**Действия:**
1. Архивировать диалог
2. Отправить WebSocket уведомление пользователю
3. Вернуть `{ message: "Обращение архивировано" }`

### PUT `/api/support/conversations/:userId/close`
**Назначение:** Закрыть диалог (постоянно) - соответствие 152-ФЗ (админ и консультант)
**Действия:**
1. Закрыть диалог (статус = 'closed')
2. Отправить WebSocket уведомление пользователю
3. Вернуть `{ message: "Обращение закрыто" }`

### PUT `/api/support/conversations/:userId/reopen`
**Назначение:** Переоткрыть архивный диалог (админ и консультант)
**Действия:**
1. Переоткрыть архивный диалог (статус = 'open')
2. Отправить WebSocket уведомление всем администраторам
3. Вернуть `{ message: "Обращение переоткрыто" }`

### GET `/api/support/conversation-status`
**Назначение:** Получить текущий статус диалога пользователя (клиент-сайдная точка)
**Требование:** Аутентификация обязательна
**Возвращает:** `{ status: 'open' | 'archived' | 'closed' | 'none' }`

### GET `/api/support/closed-search?email=X&dateFrom=Y&dateTo=Z`
**Назначение:** Поиск закрытых диалогов по email и датам (админ и консультант)
**Query параметры:**
- `email` - поиск по email (частичное совпадение)
- `dateFrom` - закрытые после этой даты (ISO 8601)
- `dateTo` - закрытые до этой даты (ISO 8601)
**Возвращает:** Массив закрытых диалогов с последним сообщением

### Обновление POST `/api/support/messages`
**Новое поведение:**
- ✅ Вызывает `getOrCreateConversation()` для автопереоткрытия архивных
- ✅ Вызывает `updateLastMessageTime()` для обновления времени
- ✅ Отправляет WebSocket уведомления всем админам и консультантам

---

## 4. Админ-панель (client/src/pages/admin/support-chat-page.tsx)

### Структура интерфейса

#### Три вкладки навигации:
1. **"Открытые"** (Статус = 'open')
   - Активные диалоги, требующие ответа
   - Кнопки действия: "Архивировать" | "Закрыть"

2. **"Архив"** (Статус = 'archived')
   - Разрешенные диалоги, которые можно переоткрыть
   - Кнопки действия: "Переоткрыть" | "Закрыть"

3. **"Закрытые"** (Статус = 'closed')
   - Постоянно закрытые диалоги, сохраняемые по 152-ФЗ
   - Кнопки действия: Только просмотр (нет редактирования)
   - Интеграция поиска:
     - Поле ввода для поиска по email
     - Поля для фильтра по датам (от/до)
     - Кнопка "Поиск"

### Компактный UI (~20% меньше)

#### Размеры элементов:
- Заголовок: `text-base` вместо `text-lg`
- Пэдинги: `px-3 py-2` вместо стандартных
- Иконки: `h-3 w-3` вместо `h-4 w-4`
- Текст: `text-xs` для вспомогательной информации
- Кнопки: `h-7 text-xs` для вкладок

#### Сокращения:
- Удалены счетчики непрочитанных сообщений (unreadCount)
- Список диалогов: отступы `p-2.5` вместо `p-4`
- Сообщение: размер `text-xs` вместо `text-sm`
- Без горизонтальных прокруток на уровне страницы

### Функциональность

#### Список диалогов (левая колонка):
- ✅ Отображение последнего сообщения (2 строки max)
- ✅ Время последнего сообщения
- ✅ Выделение выбранного диалога
- ✅ Сортировка по `lastMessageAt` (самые свежие сверху)
- ✅ Ховер-эффекты для интерактивности

#### Область сообщений (центральная колонка):
- ✅ Автоматический скролл вниз при новых сообщениях
- ✅ Выделение сообщений (от клиента vs от админа)
- ✅ Временные метки для каждого сообщения (HH:mm)
- ✅ Input скрыта для закрытых диалогов
- ✅ Сообщение "Чат закрыт. Сохранено по 152-ФЗ" для закрытых

#### Информация о клиенте (правая колонка):
- ✅ Личные данные (Имя, Email, Телефон, Бонусы)
- ✅ История заказов с деталями (№, дата, сумма, статус)
- ✅ Скроллируемая область для заказов (max-height: 280px)

---

## 5. Видджет чата пользователя (client/src/components/support-chat-widget.tsx)

### Поведение по статусу

#### Статус 'open' или 'archived':
- ✅ Отображение всех сообщений
- ✅ Input видна, пользователь может писать
- ✅ Real-time обновление через WebSocket

#### Статус 'closed':
- ✅ Скрытие всех сообщений (не удалены, просто спрятаны)
- ✅ Отображение экрана: "Чат закрыт" + кнопка "Начать новый чат"
- ✅ Input скрыта (нет возможности писать)
- ✅ WebSocket обновляет статус каждые 5 секунд

### Функциональность

#### Загрузка статуса:
- ✅ GET `/api/support/conversation-status` при открытии
- ✅ Автоматический рефреш каждые 5 секунд (`refetchInterval: 5000`)
- ✅ Переключение UI в зависимости от статуса

#### WebSocket события:
- ✅ Обработка `conversation_closed` - переход в режим просмотра
- ✅ Обработка `conversation_archived` - остается активен (архив еще пишет)
- ✅ Автоматический переход на экран "Новый чат" при закрытии

#### Input и отправка:
- ✅ Textarea скрыта для закрытых диалогов
- ✅ Enter для отправки, Shift+Enter для новой строки
- ✅ Оптимистичные обновления (instant UI feedback)
- ✅ Rollback при ошибке

### Размеры и позиционирование
- ✅ Ширина: 315px (desktop) или 90vw (мобиль)
- ✅ Высота: 487px (desktop) или 55vh (мобиль)
- ✅ Позиция: fixed, bottom-right, z-index 9999
- ✅ Анимация при открытии: slide-in-from-bottom-4

---

## 6. Лаунчер чата (client/src/components/support-chat-launcher.tsx)

### Отображение
- ✅ Только для аутентифицированных пользователей
- ✅ Скрыто для администраторов, маркетологов и консультантов
- ✅ Fixed позиция: bottom-6, right-6, z-index 9999

### Анимация переключения иконок
- ✅ Закрыто: `MessageCircle` иконка
- ✅ Открыто: `X` иконка
- ✅ Плавная анимация смены иконок (fade-in duration-200)
- ✅ Увеличение размера кнопки (h-[52px] w-[52px])
- ✅ Тень и ховер-эффекты

---

## 7. Бизнес-логика системы

### Жизненный цикл диалога

```
┌─────────────────────────────────────────────────────────┐
│                    НОВЫЙ ДИАЛОГ                         │
│              (Первое сообщение клиента)                │
│                  Статус: 'open'                         │
└──────────────────────┬──────────────────────────────────┘
                       │
         ┌─────────────┼─────────────┐
         ▼             ▼             ▼
      [ОТКРЫТ]   [АРХИВИРОВАН]  [ЗАКРЫТ]
      
    СТАТУС: OPEN
    ─────────────
    • Клиент может писать
    • Админ может архивировать или закрыть
    • Автоматическое переоткрытие из архива
    • Время последнего сообщения обновляется
    • Видимость: есть
    
    СТАТУС: ARCHIVED
    ─────────────────
    • Разрешенный диалог
    • Клиент может снова написать → автопереходит в OPEN
    • Админ может переоткрыть или закрыть
    • Временная метка: archivedAt
    • Видимость: есть (до переоткрытия)
    
    СТАТУС: CLOSED
    ──────────────
    • Постоянное состояние (соответствие 152-ФЗ)
    • Диалог НЕ МОЖЕТ быть переоткрыт
    • Сообщения НЕ видны клиенту (спрятаны в UI)
    • Сообщения ХРАНЯТСЯ В БД на 3 года
    • Временная метка: closedAt
    • Видимость: нет для клиента, есть для поиска админом
```

### Правила переходов

| Из \ В | OPEN | ARCHIVED | CLOSED |
|--------|------|----------|--------|
| OPEN   | - | Админ архивирует | Админ закрывает |
| ARCHIVED | Клиент пишет / Админ переоткрывает | - | Админ закрывает |
| CLOSED | ❌ НЕВОЗМОЖНО | ❌ НЕВОЗМОЖНО | - |

### Сортировка диалогов

**По `lastMessageAt` (DESC)** - новые сообщения выводят диалог в начало списка

Это позволяет администраторам быстро видеть активные диалоги, требующие ответа.

---

## 8. Соответствие законодательству (152-ФЗ)

### Требования РФ по защите персональных данных:
- ✅ **Минимальный период хранения**: 3 года после закрытия диалога
- ✅ **Хранилище**: Сообщения остаются в БД даже после закрытия
- ✅ **Визуальное скрытие**: Закрытые диалоги не видны клиентам в UI
- ✅ **Поиск администратором**: Возможность найти закрытые диалоги по email и датам
- ✅ **Временные метки**: Все переходы статусов записаны с временем

---

## 9. WebSocket уведомления

### События трансляции

#### Для администраторов:
- ✅ `new_message` - новое сообщение в любом диалоге
- ✅ `conversation_archived` - диалог архивирован
- ✅ `conversation_closed` - диалог закрыт
- ✅ `conversation_reopened` - диалог переоткрыт

#### Для клиентов:
- ✅ `new_message` - ответ от администратора
- ✅ `conversation_archived` - их диалог архивирован
- ✅ `conversation_closed` - их диалог закрыт

### Трансляция целевых уведомлений
- ✅ Уведомление отправляется только соответствующим пользователям
- ✅ Админам - всем со ролями admin/consultant
- ✅ Клиентам - конкретному владельцу диалога

---

## 10. Файлы реализации

### Backend
- `server/storage.ts` - 9 новых/обновленных функций для управления диалогами
- `server/routes.ts` - 6 новых endpoints + обновление существующего POST

### Frontend
- `client/src/pages/admin/support-chat-page.tsx` - полная переработка админ-панели
- `client/src/components/support-chat-widget.tsx` - поддержка закрытых диалогов
- `client/src/components/support-chat-launcher.tsx` - плавная анимация переключения
- `client/src/lib/websocket.ts` - обработка новых WebSocket событий

### Database
- `shared/schema.ts` - обновленная схема `supportConversations` таблицы

---

## 11. Статус реализации

✅ **ПОЛНОСТЬЮ ЗАВЕРШЕНО**

Все компоненты системы реализованы и протестированы:
- ✅ Бэкенд: все функции и endpoints работают
- ✅ Админ-панель: три вкладки, компактный UI, поиск
- ✅ Видджет клиента: проверка статуса, скрытие закрытых
- ✅ WebSocket: уведомления о смене статуса
- ✅ Законодательство: соответствие 152-ФЗ

---

## 12. Тестирование на практике

### Сценарий 1: Открытый диалог
1. Клиент открывает чат → `status: 'open'`
2. Клиент пишет сообщение → `lastMessageAt` обновляется
3. Администратор видит в "Открытые"
4. Администратор пишет ответ
5. Клиент видит ответ в real-time

### Сценарий 2: Архивирование
1. Администратор нажимает "Архивировать"
2. Диалог переходит в "Архив" → `status: 'archived'`, `archivedAt: now()`
3. Клиент пишет новое сообщение → автоматически `status: 'open'`
4. Диалог снова в "Открытые"

### Сценарий 3: Закрытие (152-ФЗ)
1. Администратор нажимает "Закрыть"
2. Диалог переходит в "Закрытые" → `status: 'closed'`, `closedAt: now()`
3. Клиент видит "Чат закрыт, начните новый"
4. Администратор может найти диалог через поиск по email и датам
5. Данные хранятся 3 года в БД

---

## История изменений

**Дата создания:** 23 ноября 2024 г.  
**Версия:** 1.0 (Three-Tier Support Chat System)  
**Статус:** Полная реализация и развертывание
